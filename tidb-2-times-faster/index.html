

<!DOCTYPE html>
<html lang="zh-cn" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="标题党，今天给 TiDB 水了个有意思的 PR，随便写个 blog 记录一下。文末粉丝福利">
  <meta name="author" content="TennyZhuang">
  <meta name="keywords" content="">
  
  <title>Copy &amp; Paste 三行代码让 TiDB 性能翻倍 - 纯纯的 Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.zhuangty.com","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"UA-120895130-2","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>纯纯的 Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Copy & Paste 三行代码让 TiDB 性能翻倍">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-10 14:07" pubdate>
        2021年7月10日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      27
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Copy &amp; Paste 三行代码让 TiDB 性能翻倍</h1>
            
            <div class="markdown-body">
              <p>标题党，今天给 TiDB 水了个有意思的 PR，随便写个 blog 记录一下。<strong>文末粉丝福利</strong></p>
<a id="more"></a>

<p>上午摸鱼的时候，读了雷宇哥哥的文章 <a target="_blank" rel="noopener" href="https://internals.tidb.io/t/topic/174">I beat TiDB with 20 LOC</a>，这篇文章非常有意思，推荐 go 吹/go 黑都可以读一读，通过这篇文章，我发现了 cgo 比想象的要快很多，以及 go 编译器比想象更烂，以至于 cgo 的 overhead 完全抵消了还不够。在学习 TiDB 先进经验的时候，看到了一段有意思的代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *builtinArithmeticPlusIntSig)</span> <span class="hljs-title">plusSS</span><span class="hljs-params">(result *chunk.Column, lhi64s, rhi64s, resulti64s []<span class="hljs-keyword">int64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(lhi64s); i++ &#123;<br>        <span class="hljs-keyword">if</span> result.IsNull(i) &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br><br>        lh, rh := lhi64s[i], rhi64s[i]<br>        <span class="hljs-keyword">if</span> (lh &gt; <span class="hljs-number">0</span> &amp;&amp; rh &gt; math.MaxInt64-lh) || (lh &lt; <span class="hljs-number">0</span> &amp;&amp; rh &lt; math.MinInt64-lh) &#123;<br>            <span class="hljs-keyword">return</span> types.ErrOverflow.GenWithStackByArgs(<span class="hljs-string">&quot;BIGINT&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;(%s + %s)&quot;</span>, b.args[<span class="hljs-number">0</span>].String(), b.args[<span class="hljs-number">1</span>].String()))<br>        &#125;<br><br>        resulti64s[i] = lh + rh<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>要理解这段代码，首先我们需要理解什么是 chunk。chunk 是一种列式内存格式，是 <a target="_blank" rel="noopener" href="https://arrow.apache.org/">Apache Arrow</a> 的一种实现，具体可以参考 <a target="_blank" rel="noopener" href="https://pingcap.com/blog-cn/tidb-source-code-reading-10/">TiDB 源码阅读系列文章（十）Chunk 和执行框架简介</a>。对于这里的 Int 类型，Column 的内部其实是一个 int64 array 和一个 bitmap。</p>
<p><img src="https://download.pingcap.com/images/blog-cn/tidb-source-code-reading-10/1.png" srcset="/img/loading.gif" lazyload alt="Int64Column 的实现"></p>
<p>这段代码的目的就是将 lhi64s 和 rhi64s 加和的结果保存到 resulti64s 中。为了彻底理解这段代码，我们还需要关注一下调用它的函数 <code>builtinArithmeticPlusIntSig.vecEvalInt</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *builtinArithmeticPlusIntSig)</span> <span class="hljs-title">vecEvalInt</span><span class="hljs-params">(input *chunk.Chunk, result *chunk.Column)</span> <span class="hljs-title">error</span></span> &#123;<br>	n := input.NumRows()<br>	<br>	<span class="hljs-comment">// ...</span><br>	<span class="hljs-comment">// Calculate lh and rh</span><br>	result.MergeNulls(lh)<br>	result.MergeNulls(rh)<br><br>	lhi64s := lh.Int64s()<br>	rhi64s := rh.Int64s()<br>	resulti64s := result.Int64s()<br><br>	isLHSUnsigned := mysql.HasUnsignedFlag(b.args[<span class="hljs-number">0</span>].GetType().Flag)<br>	isRHSUnsigned := mysql.HasUnsignedFlag(b.args[<span class="hljs-number">1</span>].GetType().Flag)<br><br>	<span class="hljs-keyword">switch</span> &#123;<br>	<span class="hljs-keyword">case</span> isLHSUnsigned &amp;&amp; isRHSUnsigned:<br>		err = b.plusUU(result, lhi64s, rhi64s, resulti64s)<br>	<span class="hljs-keyword">case</span> isLHSUnsigned &amp;&amp; !isRHSUnsigned:<br>		err = b.plusUS(result, lhi64s, rhi64s, resulti64s)<br>	<span class="hljs-keyword">case</span> !isLHSUnsigned &amp;&amp; isRHSUnsigned:<br>		err = b.plusSU(result, lhi64s, rhi64s, resulti64s)<br>	<span class="hljs-keyword">case</span> !isLHSUnsigned &amp;&amp; !isRHSUnsigned:<br>		err = b.plusSS(result, lhi64s, rhi64s, resulti64s)<br>	&#125;<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这段代码主要是根据加法算子两侧表达式的类型，决定调用具体的实现，而 plusSS 则是其中的一种（两个有符号整数相加）。但在调用具体的实现之前，已经对 lh 和 rh 分别调用了 <code>result.MergeNulls()</code>，因此在 <code>plusSS</code> 中只需要对 result 是否为空进行判断，决定是否跳过计算。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">if</span> result.IsNull(i) &#123;<br>    <span class="hljs-keyword">continue</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">if</span> (lh &gt; <span class="hljs-number">0</span> &amp;&amp; rh &gt; math.MaxInt64-lh) || (lh &lt; <span class="hljs-number">0</span> &amp;&amp; rh &lt; math.MinInt64-lh) &#123;<br>    <span class="hljs-keyword">return</span> types.ErrOverflow.GenWithStackByArgs(<span class="hljs-string">&quot;BIGINT&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;(%s + %s)&quot;</span>, b.args[<span class="hljs-number">0</span>].String(), b.args[<span class="hljs-number">1</span>].String()))<br>&#125;<br></code></pre></td></tr></table></figure>
<p>理解剩下的代码就非常直观了，做一个 overflow 判断，然后返回相加的结果。这也是针对不同符号的 Plus 函数最大的区别。</p>
<p>在 MySQL 大部分 expression 的逻辑，对于输入参数包含 NULL 的情况，输出参数往往也是 NULL，TiKV 为了 DRY，<a target="_blank" rel="noopener" href="https://github.com/tikv/tikv/pull/8331/files">使用宏简化了这个逻辑</a>。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[rpn_fn]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">like</span></span>&lt;C: Collator&gt;(target: BytesRef, pattern: BytesRef, escape: &amp;<span class="hljs-built_in">i64</span>) -&gt; <span class="hljs-built_in">Result</span>&lt;<span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">i64</span>&gt;&gt; &#123;<br>    <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(<br>        like::like::&lt;C&gt;(target, pattern, *escape <span class="hljs-keyword">as</span> <span class="hljs-built_in">u32</span>)? <span class="hljs-keyword">as</span> <span class="hljs-built_in">i64</span><br>    ))<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这段代码进行宏展开后和上面的 go 代码类似，如果参数有 null 的情况会直接跳过真实 like 的调用。但对于 Plus 这种基础的数学运算函数，事情就有了一些变化。一个常识是，分支的代价其实比 add 这种基础指令大很多，在高效的列式执行逻辑里，这里引入了两个 branch 操作，相比于运算（一次 add）本身来说，这两个 branch 才是最大的 overhead。</p>
<p>且这两个 branch 是必要的 check，同时也是 unlikely 的（大概率会走 else 分支）。在完全不改变代码逻辑的情况下，我们可以<a target="_blank" rel="noopener" href="https://github.com/pingcap/tidb/pull/25466">将它们优化成一个 branch</a>。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *builtinArithmeticPlusIntSig)</span> <span class="hljs-title">plusSS</span><span class="hljs-params">(result *chunk.Column, lhi64s, rhi64s, resulti64s []<span class="hljs-keyword">int64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(lhi64s); i++ &#123;<br>		lh, rh := lhi64s[i], rhi64s[i]<br><br>		<span class="hljs-keyword">if</span> (lh &gt; <span class="hljs-number">0</span> &amp;&amp; rh &gt; math.MaxInt64-lh) || (lh &lt; <span class="hljs-number">0</span> &amp;&amp; rh &lt; math.MinInt64-lh) &#123;<br>			<span class="hljs-keyword">if</span> result.IsNull(i) &#123;<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			<span class="hljs-keyword">return</span> types.ErrOverflow.GenWithStackByArgs(<span class="hljs-string">&quot;BIGINT&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;(%s + %s)&quot;</span>, b.args[<span class="hljs-number">0</span>].String(), b.args[<span class="hljs-number">1</span>].String()))<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>是的，代码改动只有三行，且只是原封不动 Copy &amp; Paste（点题），我们来看看 benchmark 的结果。TiDB 非常贴心地提供了表达式模块的 benchmark 脚本，我们可以直接使用：</p>
<p><img src="https://user-images.githubusercontent.com/9161438/125152817-e68d9000-e181-11eb-970d-ba39ed400017.png" srcset="/img/loading.gif" lazyload alt="Benchmark PlusInt"></p>
<p>可以看到，四种函数的提升都是非常可观的。其中第一个 Case 更是直接性能翻倍。</p>
<p>这个优化的原理是非常简单的，<code>Plus</code> 这种基础函数满足两个特性：</p>
<ol>
<li>运算本身比 check 轻量。</li>
<li>运算不会 crash，且没有副作用。</li>
</ol>
<p>那么我们可以直接删除 null check 的三行代码，因为 null 的结果已经被写到 result 的 bitmap 里了，这里无脑做一下计算就可以。但由于 overflow check 的存在，我们不能返回非预期的 overflow 错误（可以说 plus 运算本身无状态，overflow check 引入了状态），因此如果发生了 overflow 的话，我们得确认本身不是 null，如果确认不是 null 的话，才返回错误。从某种意义上，这个优化可以认为是手动帮 CPU 做流水线执行。</p>
<hr>
<p><img src="https://user-images.githubusercontent.com/9161438/125152990-49335b80-e183-11eb-82cb-dc800574c956.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>上面的 PR 是我花十分钟写的，我是想再给力一点的，但是懒（躺），下面只说失败的尝试和思路。</p>
<p>首先是想办法优化掉 overflow check 的 branch，我先把 overflow check 的 branch 提取到外侧：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *builtinArithmeticPlusIntSig)</span> <span class="hljs-title">plusSS</span><span class="hljs-params">(result *chunk.Column, lhi64s, rhi64s, resulti64s []<span class="hljs-keyword">int64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>+       <span class="hljs-keyword">var</span> hasOverflow <span class="hljs-keyword">int64</span> = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(lhi64s); i++ &#123;<br>                lh, rh := lhi64s[i], rhi64s[i]<br><br>-               <span class="hljs-keyword">if</span> (lh &gt; <span class="hljs-number">0</span> &amp;&amp; rh &gt; math.MaxInt64-lh) || (lh &lt; <span class="hljs-number">0</span> &amp;&amp; rh &lt; math.MinInt64-lh) &#123;<br>-                       <span class="hljs-keyword">if</span> result.IsNull(i) &#123;<br>-                               <span class="hljs-keyword">continue</span><br>-                       &#125;<br>-                       <span class="hljs-keyword">return</span> types.ErrOverflow.GenWithStackByArgs(<span class="hljs-string">&quot;BIGINT&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;(%s + %s)&quot;</span>, b.args[<span class="hljs-number">0</span>].String(), b.args[<span class="hljs-number">1</span>].String()))<br>-               &#125;<br>-<br>+               hasOverflow |= (b2i(lh &gt; <span class="hljs-number">0</span>) &amp; b2i(rh &gt; math.MaxInt64-lh)) | (b2i(lh &lt; <span class="hljs-number">0</span>)&amp;b2i(rh &lt; math.MinInt64-lh))&amp;b2iNot(result.IsNull(i))<br>                resulti64s[i] = lh + rh<br>        &#125;<br>+<br>+       <span class="hljs-keyword">if</span> <span class="hljs-keyword">uint64</span>(hasOverflow) &gt; <span class="hljs-number">0</span> &#123;<br>+               <span class="hljs-keyword">return</span> types.ErrOverflow.GenWithStackByArgs(<span class="hljs-string">&quot;BIGINT&quot;</span>, <span class="hljs-string">&quot;overflow&quot;</span>)<br>+       &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br> &#125;<br></code></pre></td></tr></table></figure>
<p>这个优化对逻辑是有变更的，因为报错信息里没法输出正确的数字了，但也不是完全没有办法，考虑到 overflow 是小概率事件，我们可以发现 overflow 以后再循环一次，拿到具体 overflow 的数字。</p>
<p><code>b2i</code> 和 <code>b2iNot</code> 大概就是 bool2Int，具体懒得贴了，反正大道至简不需要解释。实测效果大概 benchmark 低了一倍，我又懒得看汇编调优（下次高兴了再水一篇 blog）。猜测有几个原因：</p>
<ol>
<li>Overflow check 比较重，原来可以短路求值的计算现在强制计算了，代价超过了 branch 运算。</li>
<li>Go 的优化比较拉，我写的位运算也比较拉。</li>
</ol>
<p>但总之想优化掉 overflow check 是一件 non-trivial 的事情，</p>
<p>既然解决不了问题，我们不妨解决提问题的人。对于 AP 性能有极致追求的用户，我们可以提供某种 non-strict sql_mode，允许整型 overflow，结果是未定义的，这样我们就能自由地去掉 check 了。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// 这里已经不需要四种符号的版本了</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *builtinArithmeticPlusIntSig)</span> <span class="hljs-title">plusNonStrict</span><span class="hljs-params">(result *chunk.Column, lhi64s, rhi64s, resulti64s []<span class="hljs-keyword">int64</span>)</span></span> &#123;<br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(lhi64s); i++ &#123;<br>                lh, rh := lhi64s[i], rhi64s[i]<br>                resulti64s[i] = lh + rh<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;&#125;<br></code></pre></td></tr></table></figure>
<hr>
<p><img src="https://user-images.githubusercontent.com/9161438/125152990-49335b80-e183-11eb-82cb-dc800574c956.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>能啊，直接看雷宇哥哥文章的 SIMD 版本 <a target="_blank" rel="noopener" href="https://internals.tidb.io/t/topic/174">I beat TiDB with 20 LOC</a>。</p>
<p>只能说，TiDB 的 Executor 还有很长的路要走（</p>
<hr>
<p><strong>你是不是标题党？这哪里提升两倍了？</strong></p>
<p>是，expression 的 benchmark 翻倍，但在整个 SQL 的生命流程中只是微不足道的一部分，特别是 TP 的请求。即使对于复杂的 AP 请求，除非是完全从本地节点的 cache memory engine 中读取的数据，否则相同的数据量网络开销大概率也会超过这部分的优化效果（特别是 TiDB 和 TIKV 交互还用的 gRPC，那就更拉了）。</p>
<hr>
<p>说好的福利（伪）：我改完 Plus 就懒得改了，目测 Sub/And/Or/Not/Xor/… 肯定都能提升的，Mul/Div/Mod 可能需要 benchmark 一下才知道有没有提升，同时 TiKV 上也可以水一堆，感兴趣的可以去水一个 PR 薅 TiDB 的 new contributor 周边杯子。有能力的也可以把 non-strict Plus 实现一下（也很 trivial，就是要思考一下用户接口）。</p>
<!--
option = {
    title: {
        text: 'PlusInt',
        subtext: ''
    },
    tooltip: {
        trigger: 'axis'
    },
    legend: {
        data: ['优化前', '优化后']
    },
    toolbox: {
        show: true,
        feature: {
            dataView: {show: false, readOnly: false},
            magicType: {show: false, type: ['line', 'bar']},
            restore: {show: false},
            saveAsImage: {show: true}
        }
    },
    calculable: true,
    xAxis: [
        {
            type: 'category',
            data: ['VecBuiltinFunc-12', 'VecBuiltinFunc#01-12', 'VecBuiltinFunc#02-12', 'VecBuiltinFunc#03-12']
        }
    ],
    yAxis: [
        {
            type: 'value'
        }
    ],
    series: [
        {
            name: '优化前',
            type: 'bar',
            data: [251072, 505320, 446617, 375538],
            markPoint: {
                data: [
                    {type: 'max', name: '最大值'},
                    {type: 'min', name: '最小值'}
                ]
            },
        },
        {
            name: '优化后',
            type: 'bar',
            data: [537535, 806791, 487568, 442723],
            markPoint: {
                data: [
                    {name: '年最高', value: 182.2, xAxis: 7, yAxis: 183},
                    {name: '年最低', value: 2.3, xAxis: 11, yAxis: 3}
                ]
            },
        }
    ]
};
-->
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Programming/">Programming</a>
                    
                      <a class="hover-with-bg" href="/tags/Database/">Database</a>
                    
                      <a class="hover-with-bg" href="/tags/TiDB/">TiDB</a>
                    
                      <a class="hover-with-bg" href="/tags/Open-Source/">Open Source</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/builder-pattern-with-const-generics/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">使用 const generics 实现类型安全的 Builder Pattern</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/update-blog-theme/">
                        <span class="hidden-mobile">五一摸鱼周记：更新 Blog 主题、水 PR</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div class="cusdis" style="width:100%">
    <div id="cusdis_thread"
      data-host="https://blog-cusdis.vercel.app"
      data-app-id="64ba9d39-bca2-4cd8-828e-22b73177630e"
      data-page-id="a655ba6945f0031bb945040cbb9a8ee2"
      data-page-url="tidb-2-times-faster/"
      data-page-title="Copy &amp; Paste 三行代码让 TiDB 性能翻倍"
      data-theme="auto"
    >
    </div>
  </div>
  <script type="text/javascript">
    const src = 'https://blog-cusdis.vercel.app/js/widget/lang/zh-cn.js';
    Fluid.utils.createScript(src);
  </script>
  <script type="text/javascript">
    Fluid.utils.loadComments('#cusdis_thread', function() {
      Fluid.utils.createScript("https://blog-cusdis.vercel.app/js/cusdis.es.js");
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-120895130-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
